<?xml version="1.0" encoding="utf-8"?>
<configuration>
    <location path="." inheritInChildApplications="false">
        <system.webServer>
            <handlers>
                <add name="aspNetCore" path="*" verb="*" modules="AspNetCoreModuleV2" resourceType="Unspecified"/>
            </handlers>
            <aspNetCore processPath="dotnet"
                        arguments=".\SchoolFileServer.dll"
                        stdoutLogEnabled="false"
                        stdoutLogFile=".\logs\stdout"
                        hostingModel="inprocess"/>

            <!-- Security and Performance Settings -->
            <security>
                <requestFiltering>
                    <!-- Allow up to 100MB file uploads -->
                    <requestLimits maxAllowedContentLength="104857600"/>
                    <fileExtensions>
                        <!-- Allow common file types -->
                        <add fileExtension=".pdf" allowed="true"/>
                        <add fileExtension=".jpg" allowed="true"/>
                        <add fileExtension=".jpeg" allowed="true"/>
                        <add fileExtension=".png" allowed="true"/>
                        <add fileExtension=".gif" allowed="true"/>
                        <add fileExtension=".bmp" allowed="true"/>
                        <add fileExtension=".webp" allowed="true"/>
                        <add fileExtension=".mp4" allowed="true"/>
                        <add fileExtension=".avi" allowed="true"/>
                        <add fileExtension=".mov" allowed="true"/>
                        <add fileExtension=".wmv" allowed="true"/>
                        <add fileExtension=".flv" allowed="true"/>
                        <add fileExtension=".webm" allowed="true"/>
                        <add fileExtension=".mp3" allowed="true"/>
                        <add fileExtension=".wav" allowed="true"/>
                        <add fileExtension=".flac" allowed="true"/>
                        <add fileExtension=".aac" allowed="true"/>
                        <add fileExtension=".ogg" allowed="true"/>
                        <add fileExtension=".txt" allowed="true"/>
                        <add fileExtension=".doc" allowed="true"/>
                        <add fileExtension=".docx" allowed="true"/>
                        <add fileExtension=".ppt" allowed="true"/>
                        <add fileExtension=".pptx" allowed="true"/>
                        <add fileExtension=".xls" allowed="true"/>
                        <add fileExtension=".xlsx" allowed="true"/>

                        <!-- Block dangerous file types -->
                        <add fileExtension=".exe" allowed="false"/>
                        <add fileExtension=".bat" allowed="false"/>
                        <add fileExtension=".cmd" allowed="false"/>
                        <add fileExtension=".com" allowed="false"/>
                        <add fileExtension=".pif" allowed="false"/>
                        <add fileExtension=".scr" allowed="false"/>
                        <add fileExtension=".vbs" allowed="false"/>
                        <add fileExtension=".js" allowed="false"/>
                        <add fileExtension=".jar" allowed="false"/>
                        <add fileExtension=".asp" allowed="false"/>
                        <add fileExtension=".aspx" allowed="false"/>
                        <add fileExtension=".php" allowed="false"/>
                        <add fileExtension=".ps1" allowed="false"/>
                        <add fileExtension=".sh" allowed="false"/>
                    </fileExtensions>
                </requestFiltering>
            </security>

            <!-- Static Content Compression -->
            <urlCompression doDynamicCompression="true" doStaticCompression="true"/>

            <!-- Static Content Caching -->
            <staticContent>
                <clientCache cacheControlMode="UseMaxAge" cacheControlMaxAge="7.00:00:00"/>
            </staticContent>

            <!-- Custom Headers for Security -->
            <httpProtocol>
                <customHeaders>
                    <add name="X-Content-Type-Options" value="nosniff"/>
                    <add name="X-Frame-Options" value="SAMEORIGIN"/>
                    <add name="X-XSS-Protection" value="1; mode=block"/>
                    <add name="Referrer-Policy" value="strict-origin-when-cross-origin"/>
                </customHeaders>
            </httpProtocol>

            <!-- Error Pages -->
            <httpErrors>
                <remove statusCode="404" subStatusCode="-1"/>
                <error statusCode="404" prefixLanguageFilePath="" path="/Home/Error" responseMode="ExecuteURL"/>
                <remove statusCode="500" subStatusCode="-1"/>
                <error statusCode="500" prefixLanguageFilePath="" path="/Home/Error" responseMode="ExecuteURL"/>
            </httpErrors>
        </system.webServer>
    </location>
</configuration>

        <!--
          Configure IIS with this web.config file in the following structure:
          
          IIS Virtual Directory Structure:
          Default Web Site
          └── SchoolFileServer (Virtual Directory)
              ├── wwwroot (Physical Directory: C:\inetpub\wwwroot\SchoolFileServer\wwwroot)
              ├── uploads (Virtual Directory → Physical: D:\SchoolFiles\uploads)
              └── App Files (All application files)
        
          Deployment Steps:
          1. Publish the application using: dotnet publish -c Release
          2. Copy published files to: C:\inetpub\wwwroot\SchoolFileServer\
          3. Create virtual directory for uploads pointing to: D:\SchoolFiles\uploads
          4. Ensure IIS_IUSRS has read/write permissions on uploads directory
          5. Install ASP.NET Core Hosting Bundle on the server
          6. Create application pool with "No Managed Code" setting
          
          Database Location:
          - SQLite database will be created in the application root: SchoolFileServer.db
          - Ensure IIS_IUSRS has read/write permissions on the database file
          
          Default Admin Credentials:
          - Username: admin
          - Password: admin123
          
          Security Notes:
          - Change default admin password immediately after deployment
          - This configuration is optimized for intranet use only
          - File upload size limit is set to 100MB
          - Dangerous file extensions are blocked
        -->
